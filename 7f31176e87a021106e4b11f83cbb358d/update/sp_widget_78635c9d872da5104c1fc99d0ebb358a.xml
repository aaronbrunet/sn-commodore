<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function(spModal,$window,$scope,spUtil) {
  /* widget controller */
  var c = this;
  var data = c.data;

	c.activeTab = 'upcoming';

	c.page = function(action){
		c.loading = true;
		if(action == 'next'){
			c.data.prev = c.data.start + c.data.pagination;
			c.data.next = c.data.end + c.data.pagination <= c.data.records ? c.data.end + c.data.pagination : c.data.records;
			c.data.curr_page +=1;
		}
		if(action == 'prev'){
			c.data.prev = c.data.start - c.data.pagination > -1 ? c.data.start - c.data.pagination : 0;
			c.data.next = c.data.prev + c.data.pagination;
			c.data.curr_page -=1;
			
		}
		c.data.action = action;
		c.server.update().then(function(){
			c.loading = false;
		});
		
	}

  c.filterList = function(action){
	  	  c.activeTab = action;	 
		  c.data.filter = action;

		  //reset page
		  c.data.prev = 0;
		  c.data.next = c.data.pagination;
		  data.curr_page = 1;
		  
		  c.server.update();
  }
  c.clickCard = function(event,options){
	  if(data.allow_modal){
		options.display = 'modal-card';
		spModal.open({
			title: data.modal_title || 'More Information',
			widget: 'cc-event-card',
			widgetInput: options,
			buttons: options.buttons
		}).then(function(btn){
			console.log(btn);
			$window.location.href = btn.url;//event.data.event_href;
		})
	  }

  };
};]]></client_script>
        <controller_as>c</controller_as>
        <css>.cc-list-row.list {&#13;
	grid-template-columns: 1fr;&#13;
  	min-height: 50rem;&#13;
}&#13;
&#13;
.control-panel {&#13;
	margin: 2rem 0;&#13;
}&#13;
.pagination  {&#13;
	display: flex;&#13;
    flex-direction: row;&#13;
    justify-content: flex-end;&#13;
    align-items: center;  &#13;
  &#13;
  span {&#13;
  	background-color: $cc-grey-light;&#13;
    padding: .5rem .5rem;&#13;
  }&#13;
}&#13;
&#13;
.loading {&#13;
    align-self: center;&#13;
    justify-self: center;&#13;
}&#13;
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>cc-event-list</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>CC Event List</name>
        <option_schema>[{"name":"limit","section":"Presentation","default_value":"3","label":"Number of Events","type":"choice","choices":[{"label":"1","value":"1"},{"label":"3","value":"3"},{"label":"6","value":"6"},{"label":"9","value":"9"},{"label":"all","value":"all"}]},{"name":"title","section":"Presentation","default_value":"Events","label":"Title","type":"string"},{"displayValue":"Club Events","name":"style","display_value_list":[],"section":"Presentation","default_value":"cards","label":"Style","type":"choice","choices":[{"label":"cards","value":"cards"},{"label":"list","value":"list"}],"value":"x_snc_commodore_0_events","ed":{"reference":"x_snc_commodore_0_events"}},{"name":"filter","section":"Data","default_value":"upcoming","label":"Filter","type":"choice","choices":[{"label":"upcoming","value":"upcoming"},{"label":"past","value":"past"}]},{"name":"pagination","section":"Data","default_value":"5","label":"Records per page","type":"integer"}]</option_schema>
        <public>false</public>
        <roles>x_snc_commodore_0.cc_user</roles>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	var constants = new x_snc_commodore_0.CCUtils().getConstants();
	
	data.attendances = new x_snc_commodore_0.CCUtils().getMyRSVPEvents(gs.getUserID());
	data.options = options;
	data.limit = data.options.limit;
	data.events = [];
	data.widgets = [];
	
	data.page = $sp.getParameter('id');

	data.style = data.options.style == 'cards' ? 'list-card' : 'list-compact';	
	var filter = '';

	//data.current = 0;
	data.curr_page = 1;
	data.records = 0;
	data.pagination = data.options.pagination;

	data.start = 0;
	data.end = data.pagination;


	if(input){
		//if(input.action && input.action != ''){
			data.start = input.prev || 0;
			data.end = input.next || data.pagination;
			data.curr_page = input.curr_page || 1;
		//} 
		if(input.filter != ''){
			filter = input.filter == 'past' ? 'start<javascript:gs.beginningOfToday()^state=completed' : 'start>=javascript:gs.beginningOfToday()^stateNOT INcompleted,cancelled';
			buildList(filter,data.start,data.end);
		}

	} else {
		filter = data.options.filter == 'past' ? 'start<javascript:gs.beginningOfToday()^state=completed' : 'start>=javascript:gs.beginningOfToday()^stateNOT INcompleted,cancelled';
		buildList(filter,data.start,data.end);
	}


	function buildList(filter,start,end){
		console.log(filter);
		var events = new GlideRecord('x_snc_commodore_0_events');
		events.addEncodedQuery(filter);
		events.chooseWindow(start,end,false);
		events.orderBy('start');
		events.query();	
		data.records = events.getRowCount();
		data.pages = Math.ceil(data.records / data.pagination);
		
		while(events.next()){
			if(data.limit == 'all'){
				data.limit = events.getRowCount();
			}
			var event = {};		
				
			event.sys_id = events.getValue('sys_id');
			event.live = events.getValue('state') == 'live';

			event.signup_href = "/cc?id=sc_cat_item&sys_id="+constants.CAT_ITEM_EVENTSIGNUP+"&event_id="+event.sys_id;
			event.bev_href = "/cc?id=sc_cat_item&sys_id="+constants.CAT_ITEM_BEVSIGNUP+"&event_id="+event.sys_id;
			
			event.rsvp = data.attendances.includes(event.sys_id);
			event.options = {event_id:event.sys_id,display:data.style};
			
			event.buttons = [];	

			var rsvp_btn_label = 'RSVP to Event';
			var rsvp_btn_class = 'btn-default';
			if(event.rsvp){
				rsvp_btn_label = 'Modify RSVP'; 
				rsvp_btn_class = 'cc-button-warning';

			}
			
			var rsvp_btn = {
				label: rsvp_btn_label,
				class: rsvp_btn_class,
				url: event.signup_href
			};	
			//event.buttons.push(rsvp_btn);

			var myBev = new x_snc_commodore_0.CCUtils().getMyBev(gs.getUserID(),event.sys_id);
			var bev_btn_label = 'Bring a Beverage';
			var bev_btn_url = event.bev_href;
			var bev_btn_class = 'btn-default';
			if(myBev.sys_id){
				bev_btn_label = 'Modify Beverage';
				bev_btn_url = constants.BEV_EDIT + myBev.sys_id;
				bev_btn_class = 'cc-button-warning';
			}
			var bev_btn = {
				label: bev_btn_label,
				class: bev_btn_class,
				url: bev_btn_url
			};
			//event.buttons.push(bev_btn);
				
			if(event.live){
				event.buttons.push({
					label: 'Join Live Event',
					primary: true,
					url: '/cc?id=live_event&sys_id='+event.sys_id
				});
			} else {
				event.buttons.push({
					label: 'View Event Details',
					primary: true,
					url:'/cc?id=event&sys_id='+event.sys_id
				});
			}
			event.options.buttons = event.buttons;
			//console.log(event.buttons);
			data.widgets.push($sp.getWidget("cc-event-card",event.options));
			data.events.push(event);
		}
		if($sp.getParameter('id') != 'event' && $sp.getParameter('id') != 'live_event'){
			data.event_page = true;
			data.modal_title = 'Cellar Club Event Details';
			data.allow_modal = true;
		} else {
			data.allow_modal = false;
			data.event_page = false;
		}
	}
	// console.log(data.widgets);
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2023-03-12 00:23:42</sys_created_on>
        <sys_id>78635c9d872da5104c1fc99d0ebb358a</sys_id>
        <sys_mod_count>172</sys_mod_count>
        <sys_name>CC Event List</sys_name>
        <sys_package display_value="Commodore's Club" source="x_snc_commodore_0">7f31176e87a021106e4b11f83cbb358d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Commodore's Club">7f31176e87a021106e4b11f83cbb358d</sys_scope>
        <sys_update_name>sp_widget_78635c9d872da5104c1fc99d0ebb358a</sys_update_name>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2023-04-08 14:57:47</sys_updated_on>
        <template><![CDATA[<div class="cc-panel">
  <h3 class="cc-title">{{data.options.title}}</h3>
  <div ng-if="data.page == 'cc_events'" class="control-panel">
    <button role="button" class="cc-button {{c.activeTab == 'upcoming' ? 'cc-button-primary' : ''}}" ng-click="c.filterList('upcoming')">Upcoming</button>
    <button role="button" class="cc-button {{c.activeTab == 'past' ? 'cc-button-primary' : ''}}" ng-click="c.filterList('past')">Past</button>
  </div>
  <div class="cc-list-row {{data.options.style}}">
    <div ng-if="c.loading" class="loading"><h3>Loading ...</h3></div>
    <div ng-if="!c.loading" class="cc-list-items" ng-repeat="e in data.widgets | limitTo : data.limit">
      <div ng-if="data.options.style=='cards'" ng-click="c.clickCard(e,e.options)">
      	<sp-widget widget="e"></sp-widget>
      </div>
      <div ng-if="data.options.style=='list'">
      	<sp-widget widget="e"></sp-widget>
      </div>
    </div>    
  </div> 
  <div class="cc-controls-row">
  	<a class="cc-button-link cc-end" role="button" href="/cc?id=cc_events" ng-if="data.page != 'cc_events'">View All<i class="ri-arrow-right-s-line"></i></a>
    <div class="pagination" ng-if="data.page == 'cc_events'">
      <button ng-click="c.page('prev')" ng-disabled="data.curr_page == 1" class="cc-button-secondary cc-button">{{'<'}}</button>
        <span class="">{{data.curr_page}}/{{data.pages}}</span>
      <button ng-click="c.page('next')" ng-disabled="c.data.end >= data.records" class="cc-button-secondary cc-button">{{'>'}}</button>
     </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
